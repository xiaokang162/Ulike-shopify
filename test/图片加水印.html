<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é«˜æ¸…æ— æŸå›¾ç‰‡æ°´å°å·¥å…· (å¤šæ ¼å¼ç‰ˆ)</title>
  <style>
    :root {
      --primary-color: #007AFF;
      --bg-color: #f5f5f7;
      --panel-bg: #ffffff;
      --border-color: #e1e1e1;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      margin: 0;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
    .sidebar {
      width: 320px;
      background: var(--panel-bg);
      border-right: 1px solid var(--border-color);
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
    }

    .control-group {
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
    }

    .control-group h3 {
      font-size: 14px;
      color: #333;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .input-row {
      margin-bottom: 10px;
    }

    label {
      display: block;
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }

    input[type="range"] {
      width: 100%;
    }

    input[type="text"],
    input[type="color"],
    select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      background: #fff;
    }

    .btn {
      width: 100%;
      padding: 10px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
      text-align: center;
      display: block;
      margin-bottom: 10px;
    }

    .btn:hover {
      background-color: #0056b3;
    }

    .btn.secondary {
      background-color: #e1e1e1;
      color: #333;
    }

    .btn.secondary:hover {
      background-color: #d1d1d1;
    }

    /* æ ‡ç­¾é¡µåˆ‡æ¢ */
    .tabs {
      display: flex;
      margin-bottom: 15px;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--primary-color);
    }

    .tab {
      flex: 1;
      padding: 8px;
      text-align: center;
      cursor: pointer;
      font-size: 13px;
      background: #fff;
      color: var(--primary-color);
    }

    .tab.active {
      background: var(--primary-color);
      color: white;
    }

    /* å³ä¾§é¢„è§ˆåŒºåŸŸ */
    .preview-area {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      position: relative;
      background-image: linear-gradient(45deg, #ccc 25%, transparent 25%),
        linear-gradient(-45deg, #ccc 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #ccc 75%),
        linear-gradient(-45deg, transparent 75%, #ccc 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    }

    canvas {
      max-width: 100%;
      max-height: 100%;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
      object-fit: contain;
    }

    .hidden {
      display: none;
    }

    #fileInput {
      display: none;
    }

    /* å¯¼å‡ºåŒºåŸŸæ ·å¼ */
    .export-section {
      margin-top: auto;
      border-top: 1px solid var(--border-color);
      padding-top: 15px;
    }
  </style>
</head>

<body>

  <div class="sidebar">
    <button class="btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ ä¸Šä¼ åŸå›¾</button>
    <input type="file" id="fileInput" accept="image/*">

    <div class="tabs">
      <div class="tab active" onclick="switchTab('text')">æ–‡å­—æ°´å°</div>
      <div class="tab" onclick="switchTab('image')">å›¾ç‰‡æ°´å°</div>
    </div>

    <div id="textControls" class="control-group">
      <h3>æ–‡å­—è®¾ç½®</h3>
      <div class="input-row">
        <label>æ°´å°å†…å®¹</label>
        <input type="text" id="watermarkText" value="Watermark Â© 2025">
      </div>
      <div class="input-row">
        <label>å­—ä½“å¤§å° (px)</label>
        <input type="range" id="fontSize" min="10" max="500" value="80">
      </div>
      <div class="input-row">
        <label>æ–‡å­—é¢œè‰²</label>
        <input type="color" id="fontColor" value="#ffffff">
      </div>
    </div>

    <div id="imageControls" class="control-group hidden">
      <h3>å›¾ç‰‡æ°´å°è®¾ç½®</h3>
      <button class="btn secondary" onclick="document.getElementById('watermarkImageInput').click()">ä¸Šä¼ æ°´å°å›¾</button>
      <input type="file" id="watermarkImageInput" accept="image/*" style="display:none">
      <div class="input-row">
        <label>ç¼©æ”¾æ¯”ä¾‹</label>
        <input type="range" id="imgScale" min="0.1" max="5.0" step="0.1" value="1.0">
      </div>
    </div>

    <div class="control-group">
      <h3>é€šç”¨å¸ƒå±€</h3>
      <div class="input-row">
        <label>é€æ˜åº¦ (0-1)</label>
        <input type="range" id="opacity" min="0.0" max="1.0" step="0.01" value="0.5">
      </div>
      <div class="input-row">
        <label>æ—‹è½¬è§’åº¦</label>
        <input type="range" id="rotate" min="-180" max="180" value="-30">
      </div>

      <div class="input-row">
        <label>æ¨¡å¼: <span id="modeLabel">å¹³é“º</span></label>
        <select id="layoutMode">
          <option value="tiled">å…¨å±å¹³é“º (æ•°é‡ç”±é—´è·æ§åˆ¶)</option>
          <option value="single">å•ä¸ªå±…ä¸­/è‡ªå®šä¹‰</option>
        </select>
      </div>

      <div id="tiledSettings">
        <div class="input-row">
          <label>æ°´å¹³é—´è· (Gap X)</label>
          <input type="range" id="gapX" min="0" max="1000" value="300">
        </div>
        <div class="input-row">
          <label>å‚ç›´é—´è· (Gap Y)</label>
          <input type="range" id="gapY" min="0" max="1000" value="300">
        </div>
      </div>

      <div id="singleSettings" class="hidden">
        <div class="input-row">
          <label>X è½´ä½ç½® (%)</label>
          <input type="range" id="posX" min="0" max="100" value="50">
        </div>
        <div class="input-row">
          <label>Y è½´ä½ç½® (%)</label>
          <input type="range" id="posY" min="0" max="100" value="50">
        </div>
      </div>
    </div>

    <div class="export-section">
      <div class="input-row">
        <label>å¯¼å‡ºæ ¼å¼</label>
        <select id="exportFormat">
          <option value="image/png">PNG (æ— æŸ/é»˜è®¤)</option>
          <option value="image/jpeg">JPG (ä½“ç§¯å°/é€‚åˆç…§ç‰‡)</option>
          <option value="image/webp">WebP (é«˜å‹ç¼©æ¯”)</option>
        </select>
      </div>
      <button class="btn" style="background-color: #28a745;" onclick="downloadImage()">â¬‡ï¸ å¯¼å‡ºé«˜æ¸…åŸå›¾</button>
    </div>
  </div>

  <div class="preview-area">
    <canvas id="canvas"></canvas>
  </div>

  <script>
    // çŠ¶æ€ç®¡ç†
    const state = {
      mainImage: null,
      wmImage: null,
      mode: 'text', // 'text' or 'image'
      text: 'Watermark Â© 2025',
      fontSize: 80,
      color: '#ffffff',
      imgScale: 1.0,
      opacity: 0.5,
      rotate: -30,
      layout: 'tiled', // 'tiled' or 'single'
      gapX: 300,
      gapY: 300,
      posX: 50,
      posY: 50
    };

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // åˆå§‹åŒ–ç»‘å®šäº‹ä»¶
    function init() {
      // è¾“å…¥ç›‘å¬
      document.getElementById('fileInput').addEventListener('change', handleMainImage);
      document.getElementById('watermarkImageInput').addEventListener('change', handleWmImage);

      // æ–‡æœ¬ç›‘å¬
      bindInput('watermarkText', 'text');
      bindInput('fontSize', 'fontSize', true);
      bindInput('fontColor', 'color');

      // å›¾ç‰‡æ°´å°ç›‘å¬
      bindInput('imgScale', 'imgScale', true);

      // é€šç”¨ç›‘å¬
      bindInput('opacity', 'opacity', true);
      bindInput('rotate', 'rotate', true);
      bindInput('gapX', 'gapX', true);
      bindInput('gapY', 'gapY', true);
      bindInput('posX', 'posX', true);
      bindInput('posY', 'posY', true);

      document.getElementById('layoutMode').addEventListener('change', (e) => {
        state.layout = e.target.value;
        toggleLayoutSettings();
        draw();
      });

      // åˆå§‹ç»˜åˆ¶æç¤º
      ctx.font = "30px Arial";
      ctx.fillText("è¯·å…ˆåœ¨å·¦ä¾§ä¸Šä¼ åŸå›¾", 50, 50);
    }

    // ç»‘å®šè¾“å…¥æ¡†åˆ°çŠ¶æ€
    function bindInput(id, key, isNumber = false) {
      const el = document.getElementById(id);
      el.addEventListener('input', (e) => {
        state[key] = isNumber ? parseFloat(e.target.value) : e.target.value;
        draw();
      });
    }

    // åˆ‡æ¢ Tab
    window.switchTab = function (type) {
      state.mode = type;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      if (type === 'text') {
        document.getElementById('textControls').classList.remove('hidden');
        document.getElementById('imageControls').classList.add('hidden');
      } else {
        document.getElementById('textControls').classList.add('hidden');
        document.getElementById('imageControls').classList.remove('hidden');
      }
      draw();
    }

    // åˆ‡æ¢å¸ƒå±€è®¾ç½®æ˜¾ç¤º
    function toggleLayoutSettings() {
      if (state.layout === 'tiled') {
        document.getElementById('tiledSettings').classList.remove('hidden');
        document.getElementById('singleSettings').classList.add('hidden');
        document.getElementById('modeLabel').innerText = "å¹³é“º";
      } else {
        document.getElementById('tiledSettings').classList.add('hidden');
        document.getElementById('singleSettings').classList.remove('hidden');
        document.getElementById('modeLabel').innerText = "å•ä¸ª";
      }
    }

    // å¤„ç†ä¸»å›¾ä¸Šä¼ 
    function handleMainImage(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          state.mainImage = img;
          // è®¾ç½®ç”»å¸ƒå°ºå¯¸ä¸ºåŸå›¾çœŸå®å°ºå¯¸ï¼ˆå…³é”®ç‚¹ï¼šä¸å‹ç¼©ï¼‰
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          draw();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    // å¤„ç†æ°´å°å›¾ç‰‡ä¸Šä¼ 
    function handleWmImage(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          state.wmImage = img;
          draw();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    // æ ¸å¿ƒç»˜åˆ¶å‡½æ•°
    function draw() {
      if (!state.mainImage) return;

      // 1. æ¸…ç©ºå¹¶ç»˜åˆ¶åŸå›¾
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.globalAlpha = 1.0;
      ctx.setTransform(1, 0, 0, 1, 0, 0); // é‡ç½®å˜æ¢
      ctx.drawImage(state.mainImage, 0, 0);

      // å‡†å¤‡æ°´å°å‚æ•°
      ctx.globalAlpha = state.opacity;
      const w = canvas.width;
      const h = canvas.height;

      if (state.layout === 'single') {
        drawOneWatermark(w * (state.posX / 100), h * (state.posY / 100));
      } else {
        // å¹³é“ºé€»è¾‘ï¼šä»ä¸­å¿ƒå‘å››å‘¨æ‰©æ•£ç»˜åˆ¶

        // è®¡ç®—é—´è·
        let stepX = state.gapX + (state.mode === 'text' ? state.fontSize * state.text.length : (state.wmImage ? state.wmImage.width * state.imgScale : 100));
        let stepY = state.gapY + (state.mode === 'text' ? state.fontSize : (state.wmImage ? state.wmImage.height * state.imgScale : 100));

        // é˜²æ­¢é—´è·è¿‡å°å¯¼è‡´æ­»å¾ªç¯/å¡é¡¿
        stepX = Math.max(stepX, 50);
        stepY = Math.max(stepY, 50);

        // ç®€å•çš„å…¨å±è¦†ç›–å¾ªç¯
        for (let x = 0; x < w; x += stepX) {
          for (let y = 0; y < h; y += stepY) {
            // ç¨å¾®é”™ä½è®©å¹³é“ºæ›´å¥½çœ‹
            let renderX = x;
            if ((y / stepY) % 2 === 1) renderX += stepX / 2;
            drawOneWatermark(renderX % w, y);
            // è¡¥å…¨å³ä¾§è¾¹ç¼˜
            if (renderX % w < stepX) drawOneWatermark((renderX % w) + w, y);
          }
        }
      }
    }

    function drawOneWatermark(x, y) {
      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(state.rotate * Math.PI / 180);

      if (state.mode === 'text') {
        ctx.font = `bold ${state.fontSize}px Arial`;
        ctx.fillStyle = state.color; // å·²ä¿®å¤å˜é‡å
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(state.text, 0, 0);
      } else if (state.mode === 'image' && state.wmImage) {
        const drawW = state.wmImage.width * state.imgScale;
        const drawH = state.wmImage.height * state.imgScale;
        ctx.drawImage(state.wmImage, -drawW / 2, -drawH / 2, drawW, drawH);
      }
      ctx.restore();
    }

    // å¯¼å‡ºåŠŸèƒ½ï¼ˆæ”¯æŒå¤šæ ¼å¼ï¼‰
    window.downloadImage = function () {
      if (!state.mainImage) {
        alert("è¯·å…ˆä¸Šä¼ åŸå›¾ï¼");
        return;
      }

      // è·å–é€‰æ‹©çš„æ ¼å¼
      const format = document.getElementById('exportFormat').value;
      let ext = 'png';
      if (format === 'image/jpeg') ext = 'jpg';
      if (format === 'image/webp') ext = 'webp';

      const link = document.createElement('a');
      link.download = `watermarked-image.${ext}`;

      // ç¬¬äºŒä¸ªå‚æ•° 1.0 è¡¨ç¤ºæœ€é«˜è´¨é‡ (ä»…å¯¹ jpeg/webp æœ‰æ•ˆï¼Œpng å¿½ç•¥)
      link.href = canvas.toDataURL(format, 1.0);
      link.click();
    }

    init();
  </script>
</body>

</html>