<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <title>图片加水印工具</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 16px;
    }

    .row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .panel {
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 6px;
      min-width: 260px;
    }

    .panel h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    label {
      display: block;
      margin-top: 6px;
      font-size: 13px;
    }

    input[type="number"],
    input[type="text"],
    input[type="color"],
    input[type="range"] {
      width: 100%;
      box-sizing: border-box;
      margin-top: 2px;
    }

    button {
      margin-top: 8px;
      padding: 6px 10px;
      cursor: pointer;
    }

    canvas {
      margin-top: 12px;
      max-width: 100%;
      border: 1px solid #ddd;
    }
  </style>
</head>

<body>
  <div class="row">
    <!-- 左侧：图片选择和导出 -->
    <div class="panel">
      <h3>原图 / 导出</h3>
      <label>
        选择原图：
        <input type="file" id="baseImageInput" accept="image/*" />
      </label>
      <label>
        选择图片水印：
        <input type="file" id="wmImageInput" accept="image/*" />
      </label>
      <button id="clearWatermarks">清空所有水印</button>
      <button id="exportPng">导出 PNG（无损）</button>
      <p style="font-size:12px;color:#666;">
        提示：canvas 分辨率自动等于原图分辨率，不会压缩画质。
      </p>
    </div>

    <!-- 中间：文字水印设置 -->
    <div class="panel">
      <h3>文字水印设置</h3>
      <label>
        文本内容：
        <input type="text" id="wmText" placeholder="例如：版权所有 / 公司名" />
      </label>
      <label>
        字号（px）：
        <input type="number" id="fontSize" value="32" min="8" max="200" />
      </label>
      <label>
        颜色：
        <input type="color" id="fontColor" value="#ffffff" />
      </label>
      <label>
        透明度（0~1）：
        <input type="range" id="textOpacity" min="0" max="1" step="0.05" value="0.5" />
      </label>
      <label>
        X 位置（像素）：
        <input type="number" id="textX" value="50" />
      </label>
      <label>
        Y 位置（像素）：
        <input type="number" id="textY" value="50" />
      </label>
      <button id="addTextWatermark">添加文字水印</button>
      <p style="font-size:12px;color:#666;">
        可以多次点击“添加文字水印”来增加多个文字水印。
      </p>
    </div>

    <!-- 右侧：图片水印设置 -->
    <div class="panel">
      <h3>图片水印设置</h3>
      <label>
        显示宽度（px）：
        <input type="number" id="imgWmWidth" value="200" min="10" />
      </label>
      <label>
        透明度（0~1）：
        <input type="range" id="imgOpacity" min="0" max="1" step="0.05" value="0.5" />
      </label>
      <label>
        X 位置（像素）：
        <input type="number" id="imgX" value="50" />
      </label>
      <label>
        Y 位置（像素）：
        <input type="number" id="imgY" value="50" />
      </label>
      <button id="addImgWatermark">添加图片水印</button>
      <p style="font-size:12px;color:#666;">
        同一张水印图片可以多次添加到不同位置和大小。
      </p>
    </div>
  </div>

  <!-- 画布预览 -->
  <canvas id="canvas"></canvas>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    const baseImageInput = document.getElementById('baseImageInput');
    const wmImageInput = document.getElementById('wmImageInput');

    const addTextBtn = document.getElementById('addTextWatermark');
    const addImgBtn = document.getElementById('addImgWatermark');
    const clearBtn = document.getElementById('clearWatermarks');
    const exportBtn = document.getElementById('exportPng');

    const wmTextEl = document.getElementById('wmText');
    const fontSizeEl = document.getElementById('fontSize');
    const fontColorEl = document.getElementById('fontColor');
    const textOpacityEl = document.getElementById('textOpacity');
    const textXEl = document.getElementById('textX');
    const textYEl = document.getElementById('textY');

    const imgWmWidthEl = document.getElementById('imgWmWidth');
    const imgOpacityEl = document.getElementById('imgOpacity');
    const imgXEl = document.getElementById('imgX');
    const imgYEl = document.getElementById('imgY');

    let baseImage = null;      // 原图 Image 对象
    let currentWmImage = null; // 当前选择的水印 Image 对象

    const textWatermarks = [];  // { text, size, color, opacity, x, y, fontFamily }
    const imageWatermarks = []; // { img, width, opacity, x, y }

    // 载入原图
    baseImageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => {
        baseImage = img;
        // canvas 真实分辨率 = 原图分辨率，保证画质
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        render();
        URL.revokeObjectURL(url);
      };
      img.src = url;
    });

    // 载入水印图片
    wmImageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => {
        currentWmImage = img;
        URL.revokeObjectURL(url);
      };
      img.src = url;
    });

    // 添加文字水印
    addTextBtn.addEventListener('click', () => {
      if (!baseImage) {
        alert('请先选择原图');
        return;
      }
      const text = wmTextEl.value.trim();
      if (!text) {
        alert('请输入文字内容');
        return;
      }
      const size = parseInt(fontSizeEl.value, 10) || 32;
      const color = fontColorEl.value || '#ffffff';
      const opacity = parseFloat(textOpacityEl.value) || 1;
      const x = parseInt(textXEl.value, 10) || 0;
      const y = parseInt(textYEl.value, 10) || 0;

      textWatermarks.push({
        text,
        size,
        color,
        opacity: Math.min(Math.max(opacity, 0), 1),
        x,
        y,
        fontFamily: 'sans-serif'
      });

      render();
    });

    // 添加图片水印
    addImgBtn.addEventListener('click', () => {
      if (!baseImage) {
        alert('请先选择原图');
        return;
      }
      if (!currentWmImage) {
        alert('请先选择图片水印文件');
        return;
      }
      const width = parseInt(imgWmWidthEl.value, 10) || 100;
      const opacity = parseFloat(imgOpacityEl.value) || 1;
      const x = parseInt(imgXEl.value, 10) || 0;
      const y = parseInt(imgYEl.value, 10) || 0;

      imageWatermarks.push({
        img: currentWmImage,
        width: width,
        opacity: Math.min(Math.max(opacity, 0), 1),
        x,
        y
      });

      render();
    });

    // 清空所有水印
    clearBtn.addEventListener('click', () => {
      textWatermarks.length = 0;
      imageWatermarks.length = 0;
      render();
    });

    // 导出 PNG（无损）
    exportBtn.addEventListener('click', () => {
      if (!baseImage) {
        alert('请先选择原图');
        return;
      }
      canvas.toBlob((blob) => {
        if (!blob) return;
        const a = document.createElement('a');
        a.download = 'watermarked.png';
        a.href = URL.createObjectURL(blob);
        a.click();
        URL.revokeObjectURL(a.href);
      }, 'image/png'); // PNG 为无损格式
    });

    // 渲染：先画原图，再画所有水印
    function render() {
      if (!baseImage) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
      }
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height);

      // 文字水印
      textWatermarks.forEach((w) => {
        ctx.save();
        ctx.globalAlpha = w.opacity;
        ctx.font = w.size + 'px ' + w.fontFamily;
        ctx.fillStyle = w.color;
        ctx.textBaseline = 'top';
        ctx.fillText(w.text, w.x, w.y);
        ctx.restore();
      });

      // 图片水印
      imageWatermarks.forEach((w) => {
        if (!w.img.complete) return;
        ctx.save();
        ctx.globalAlpha = w.opacity;
        const ratio = w.img.naturalHeight / w.img.naturalWidth;
        const drawWidth = w.width;
        const drawHeight = drawWidth * ratio;
        ctx.drawImage(w.img, w.x, w.y, drawWidth, drawHeight);
        ctx.restore();
      });
    }
  </script>
</body>

</html>